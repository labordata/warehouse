name: Build Union Names Crosswalk

on:
  workflow_call:
  workflow_dispatch:

jobs:
  build-union-names-csv:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3

      - name: Install dependencies
        run: pip install sqlite-utils csvs-to-sqlite

      - name: Download f7.db
        run: |
          curl -LO http://labordata.github.io/fmcs-f7/f7.db.zip
          unzip f7.db.zip
          rm f7.db.zip
          sqlite-utils enable-fts f7.db f7 union_name union_street union_city union_state union_zip
          sqlite-utils query f7.db "analyze"
          sqlite-utils query f7.db "vacuum"

      - name: Download nlrb.db
        run: |
          curl -LO https://github.com/labordata/nlrb-data/releases/download/nightly/nlrb.db.zip
          unzip nlrb.db.zip
          rm nlrb.db.zip
          sqlite-utils query nlrb.db "analyze"
          sqlite-utils query nlrb.db "vacuum"

      - name: Download lm20.db
        run: |
          curl -LO https://github.com/labordata/lm20/releases/download/nightly/lm20.db.zip
          unzip lm20.db.zip
          rm lm20.db.zip
          sqlite-utils query lm20.db "analyze"
          sqlite-utils query lm20.db "vacuum"

      - name: Download voluntary_recognitions.db
        run: |
          curl -LO https://github.com/labordata/nlrb-voluntary-recognitions/raw/main/voluntary_recognitions.db

      - name: Generate union_names.csv
        run: |
          (echo "ATTACH 'f7.db' AS f7; ATTACH 'nlrb.db' AS nlrb; ATTACH 'lm20.db' AS lm20; ATTACH 'voluntary_recognitions.db' AS voluntary_recognitions;"; cat scripts/union_names.sql) | sqlite3 -csv -header :memory: > union_names.csv

      - name: Zip prerequisite databases
        run: zip crosswalk-prereq-dbs.zip f7.db nlrb.db lm20.db voluntary_recognitions.db

      - name: Upload union_names.csv
        uses: actions/upload-artifact@v4
        with:
          name: union-names-csv
          path: union_names.csv

      - name: Upload prerequisite databases
        uses: actions/upload-artifact@v4
        with:
          name: crosswalk-prereq-dbs
          path: crosswalk-prereq-dbs.zip

  build-crosswalk-db:
    runs-on: ubuntu-latest
    needs: build-union-names-csv
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v3

      - name: Download union_names.csv
        uses: actions/download-artifact@v4
        with:
          name: union-names-csv

      - name: Download prerequisite databases zip
        uses: actions/download-artifact@v4
        with:
          name: crosswalk-prereq-dbs

      - name: Install labor-union-parser
        run: pip install labor-union-parser csvs-to-sqlite sqlite-utils

      - name: Generate union_names_crosswalk.csv
        run: labor-union-parser union_names.csv > union_names_crosswalk.csv

      - name: Build union_names_crosswalk.db
        run: |
          csvs-to-sqlite union_names_crosswalk.csv union_names_crosswalk.db
          sqlite-utils create-index union_names_crosswalk.db union_names_crosswalk union_name --unique

      - name: Zip crosswalk database
        run: zip union_names_crosswalk.db.zip union_names_crosswalk.db

      - name: Delete existing release assets
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Delete existing assets if they exist (ignore errors if release doesn't exist)
          gh release delete-asset crosswalk-nightly union_names_crosswalk.db.zip --yes || true
          gh release delete-asset crosswalk-nightly crosswalk-prereq-dbs.zip --yes || true

      - name: Upload to release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: crosswalk-nightly
          name: Crosswalk Nightly Build
          body: |
            Automated nightly build of union names crosswalk database.
            Contains:
            - union_names_crosswalk.db.zip - The crosswalk database
            - crosswalk-prereq-dbs.zip - Prerequisite databases (f7.db, nlrb.db, lm20.db, voluntary_recognitions.db)
          files: |
            union_names_crosswalk.db.zip
            crosswalk-prereq-dbs.zip
          prerelease: true
